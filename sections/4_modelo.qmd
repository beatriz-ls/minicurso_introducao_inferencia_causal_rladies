---
format: 
  revealjs:
    slide-number: true
    code-link: true
    highlight-style: a11y
    chalkboard: true
    # self-contained: true
    # scrollable: true
    theme: "bea_slide_theme.scss"
---

##  {#modelo-causal data-menu-title="O Modelo Causal"}

[O Modelo Causal]{.slide-title}

<hr>

::: sanchez-font
::: purple-text
**Definimos**
:::
:::

Determinar relações causais entre variáveis é essencial para determinar efeito de uma variável em outra.

::: sanchez-font
::: purple-text
**Desafio**
:::
:::

Representar essas relações formalmente (matemáticamente)

::: sanchez-font
::: purple-text
**Resposta**
:::
:::

Definir um Modelo Causal, definido por meio de **Modelos Probabilisticos em Grafos**

------------------------------------------------------------------------

##  {data-menu-title="O Modelo Causal"}

[O Modelo Causal]{.slide-title}

[Grafo Direcionado Acíclico (DAG)]{.custom-subtitle2}

<hr>

::: body-text-s
::: sanchez-font
::: purple-text
Definição
:::
:::

Um DAG é um grafo direcionado tal que, para todo vértice, **V** , não é possível seguir setas partindo de **V** e voltar para **V**.

-   Representação causal: $V_1 \rightarrow V_2$ = "$V_1$ causa $V_2$"

::: sanchez-font
::: purple-text
Lema
:::
:::

O conjunto de pais de $\mathcal{V} \subseteq V$ em um DAG, $G = (V, \mathcal{E})$, é:
$$
Pa(\mathcal{V}) := \{V^* \in V : \exists V \in \mathcal{V} \text{ tal que } (V^*, V) \in \mathcal{E}\}
$$

::: sanchez-font
::: purple-text
Lema
:::
:::

Em um DAG, $G = (V, E)$, o conjunto de ancestrais de $\mathcal{V} \subseteq V$, $\operatorname{Anc}(\mathcal{V})$, é tal que: 
$$
\operatorname{Anc}(\mathcal{V}) \subseteq V \quad \text{e} \quad V^* \in \operatorname{Anc}(\mathcal{V}) \text{ se e somente se}
$$

$$
\exists V \in \mathcal{V} \text{ e um caminho direcionado } C \text{ tal que } C_1 = V^* \text{ e } C_i = V.
$$
:::

------------------------------------------------------------------------

[O Modelo Causal]{.slide-title}

[Modelo Probabilístico em um DAG]{.custom-subtitle2}

<hr>

::: body-text-s

::: sanchez-font
::: purple-text
Definição
:::
:::

Para $\mathcal{V}$ um conjunto de variáveis aleatórias, dizemos que uma função de densidade sobre $\mathcal{V}$, $f$, é compatível com um DAG, $\mathcal{G}$, se:

$$
f(v_1,\ldots,v_n) = \prod_{i=1}^n f(v_i \mid \mathrm{Pa}(v_i))
$$

::: sanchez-font
::: purple-text
Lema
:::
:::

Uma função de densidade $f$ é compatível com um DAG $\mathcal{G}$ se e somente se existem funções $g_1, \dots, g_n$ tais que:

$$
f(v_1, \dots, v_n) = \prod_{i=1}^{n} g_i(v_i, \mathrm{Pa}(v_i)), \quad \text{e}
$$

$$
\int g_i(v_i, \mathrm{Pa}(v_i)) \, dv_i = 1 \quad \forall i
$$
:::

------------------------------------------------------------------------

[O Modelo Causal]{.slide-title}

[Cadeia (Chain)]{.custom-subtitle2}

<hr>

::: columns
::: {.column width="50%"}
::: panel-tabset
### Output

```{r dag chain img, fig.width=5, fig.height=4, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
library(dagitty)
library(ggdag)
library(ggplot2)

# Construindo o grafo
grafo <- dagitty("dag {
V1 -> V2
V2 -> V3
}")
# Exibir a figura do grafo
ggdag(grafo, layout = "circle") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("") + ylab("")

```

### Código

```{r dag exemplo code,echo = TRUE, fig.show='hide', message=FALSE, warning=FALSE}
library(dagitty)
library(ggdag)
library(ggplot2)

# Construindo o Grafo
grafo <- dagitty("dag {
V1 -> V2
V2 -> V3
}")
# Exibir a figura do grafo
ggdag(grafo, layout = "circle") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("") + ylab("")
```
:::
:::

::: {.column width="50%"}
::: sanchez-font
::: purple-text
Observações
:::
:::

::: hr-purple
:::

-   $V_1$ é causa de $V_2$ que, por sua vez, é causa de $V_3$. Assim, $V_1$ é ancestral de $V_3$, isto é, o primeiro é a causa indireta do segundo;

-   $V_1$ e $V_3$ estão correlacionados, via $V_2$, na população;

-   $V_1$ e $V_3$ são independentes quando condicionados em $V_2$
:::
:::

------------------------------------------------------------------------

[O Modelo Causal]{.slide-title}

[Confundidor (Confounder)]{.custom-subtitle2}

<hr>

::: columns
::: {.column width="50%"}
::: panel-tabset
### Output

```{r dag confounder, fig.width=5, fig.height=4, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
library(dagitty)
library(ggdag)
library(ggplot2)

# Construindo o grafo
grafo <- dagitty("dag {
V1 -> V2
V1 -> V3
}")
# Exibir a figura do grafo
ggdag(grafo, layout = "circle") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("") + ylab("")

```

### Código

```{r dag confounder img,echo = TRUE, fig.show='hide', message=FALSE, warning=FALSE}
library(dagitty)
library(ggdag)
library(ggplot2)

# Construindo o Grafo
grafo <- dagitty("dag {
V1 -> V2
V1 -> V3
}")
# Exibir a figura do grafo
ggdag(grafo, layout = "circle") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("") + ylab("")
```
:::
:::

::: {.column width="50%"}
::: sanchez-font
::: purple-text
Observações
:::
:::

::: hr-purple
:::

-   $V_1$ é uma causa comum a $V_2$ e a $V_3$;

-   $V_2$ e $V_3$ estão correlacionados, via $V_1$, na população;

-   $V_2$ e $V_3$ são independentes quando condicionados em $V_1$.
:::
:::

------------------------------------------------------------------------

[O Modelo Causal]{.slide-title}

[Colisor (Collider)]{.custom-subtitle2}

<hr>

::: columns
::: {.column width="50%"}
::: panel-tabset
### Output

```{r dag colisor img, fig.width=5, fig.height=4, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
library(dagitty)
library(ggdag)
library(ggplot2)

# Construindo o grafo
grafo <- dagitty("dag {
V1 -> V2
V3 -> V2
}")
# Exibir a figura do grafo
ggdag(grafo, layout = "circle") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("") + ylab("")

```

### Código

```{r dag colisor code,echo = TRUE, fig.show='hide', message=FALSE, warning=FALSE}
library(dagitty)
library(ggdag)
library(ggplot2)

# Construindo o Grafo
grafo <- dagitty("dag {
V1 -> V2
V3 -> V2
}")
# Exibir a figura do grafo
ggdag(grafo, layout = "circle") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("") + ylab("")
```
:::
:::

::: {.column width="50%"}
::: sanchez-font
::: purple-text
Observações
:::
:::

::: hr-purple
:::

-   $V_1$ e $V_3$ são causas comum a $V_2$;

-   $V_1$ e $V_3$ são independentes na população;

-   $V_1$ e $V_3$ estão correlacionados quando condicionados em $V_2$.
:::
:::

------------------------------------------------------------------------

::: {.fullscreen-colored}
D-separação
:::

------------------------------------------------------------------------

[O Modelo Causal]{.slide-title}

[D-separação]{.custom-subtitle2}

<hr>

::: sanchez-font
::: purple-text
Objetivo
:::
:::

A D-separação é uma regra formal para determinar, a partir do DAG, quando dois conjuntos de variáveis (X e Y) são independentes condicionalmente em um terceiro conjunto (Z).

::: sanchez-font
::: purple-text
Regra Geral
:::
:::
Um caminho entre X e Y está bloqueado por Z se o caminho conter:

- Um não-colisor que está sendo condicionado, OU

- Um colisor que NÃO está sendo condicionado (nem seus descendentes)

:::{.notes}
Regras de Bloqueio:
- Não-colisor: Bloqueia quando condicionado
- Colisor: Bloqueia quando NÃO condicionado

Lição Principal:
Condicionar em colisor pode INTRODUZIR dependência onde não existia! Isso é contra-intuitivo mas fundamental em causalidade.
:::

    
------------------------------------------------------------------------

[O Modelo Causal]{.slide-title}

[D-separação: Exemplo]{.custom-subtitle2}

<hr>

::: columns
::: {.column width="50%"}
::: panel-tabset
### Output

```{r dag dseparacao exemplo output, fig.width=5, fig.height=4, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
grafo_exemplo <- dagitty('dag {
    V1 -> V2 <- V4
    V2 -> V3 <- V4
}')

# Visualizando
ggdag(grafo_exemplo) + theme_dag()

```

### Código

```{r dag dseparacao exemplo code,echo = TRUE, fig.show='hide', message=FALSE, warning=FALSE}
# Construindo o Grafo
grafo_exemplo <-dagitty('dag {
    V1 -> V2 <- V4
    V2 -> V3 <- V4
}')

# Visualizando
ggdag(grafo_exemplo) + theme_dag()
```
:::
:::

:::{.column width="50%"}

::: sanchez-font
::: purple-text
Dúvidas
:::
:::

:::hr-purple
1. V1 e V3 são d-separados marginalmente?
2. V1 e V3 são d-separados dado V2?
3. V1 e V3 são d-separados dado V2 e V4?
:::

:::
:::

:::{.notes}

1. V1 e V3 são d-separados marginalmente? Não
Existem caminhos ativos:
- Caminho 1: V1 → V2 → V3 (V2 não é colisor, caminho ativo)
- Caminho 2: V1 → V2 ← V4 → V3 (V2 é colisor, mas não estamos condicionando nele → bloqueado)
Como um caminho está ativo, NÃO são d-separados.

2. V1 e V3 são d-separados dado V2? NÃO
Agora o segundo caminho se torna ativo:
- Caminho 1: V1 → V2 → V3 (V2 não é colisor, condicionamos nele → bloqueado ✓)
- Caminho 2: V1 → V2 ← V4 → V3 (V2 é colisor, condicionamos nele → ATIVO ✗)
Condicionar em colisor ABRE o caminho!

3. V1 e V3 são d-separados dado V2 e V4?SIM
Ambos os caminhos bloqueados:
- Caminho 1: V1 → V2 → V3 (V2 não é colisor, condicionamos → bloqueado ✓)
- Caminho 2: V1 → V2 ← V4 → V3 (V4 não é colisor, condicionamos → bloqueado ✓)
Todos os caminhos bloqueados!

Implicações Práticas:

Se você quer estudar o efeito de V1 em V3:
- Não condicione apenas em V2 (introduz viés!)
- Condicione em V2 E V4 para bloquear todos os caminhos
:::

------------------------------------------------------------------------

[O Modelo Causal]{.slide-title}

[D-separação: Exemplo no R]{.custom-subtitle2}

<hr>

```{r dseparacao, echo=TRUE, warning=FALSE}
library(dagitty)

# PERGUNTA 1: V1 e V3 são d-separados marginalmente?
dseparated(grafo_exemplo, "V1", "V3")

# PERGUNTA 2: V1 e V3 são d-separados dado V2?
dseparated(grafo_exemplo, "V1", "V3", "V2")

# PERGUNTA 3: V1 e V3 são d-separados dado V2 e V4?
dseparated(grafo_exemplo, "V1", "V3", c("V2", "V4"))
```


```{r funcao independencia, echo=TRUE, warning=FALSE}
# Isso mostra TODAS as relações de independência que o grafo implica
impliedConditionalIndependencies(grafo_exemplo)
```


