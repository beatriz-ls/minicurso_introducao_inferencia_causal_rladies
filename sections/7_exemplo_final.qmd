---
format: 
  revealjs:
    slide-number: true
    code-link: true
    highlight-style: a11y
    chalkboard: true
    # self-contained: true
    # scrollable: true
    theme: "bea_slide_theme.scss"
---

::: {.fullscreen-colored}
Aplicação Final: \
Rede de mosquitos e Risco de Malária
:::

---------------------------------------------------------------------

##  {#bibliotecas2 data-menu-title="Revisando Bibliotecas"}

[Revisando Bibliotecas necessárias]{.slide-title}

<hr>

```{r install_packages 1, echo=TRUE, warning=FALSE}
library(ggdag)        # Construção de gráficos
library(dagitty)      # Backdoor
library(tidyverse)    # Manipulação de dados e visualização
library(causalworkshop) # Dados simulados
library(broom)        # Tidy de modelos
library(propensity)   # Cálculo de pesos IPW
library(halfmoon)     # Diagnóstico de balanceamento
library(rsample)      # Bootstrap
library(purrr)        # Iteração
library(patchwork)    # Ajustar gráficos

#install.packages("pak")
#pak::pak("r-causal/causalworkshop")
```

-------------------------------------------------------------------

##  {#dados data-menu-title="Dados"}

[Nosso dataset]{.slide-title}

<hr>

Dados simulados criados pelo [Prof. Dr. Andrews Heiss]{https://www.andrewheiss.com/}

- **Objetivo:** Verificar se mosquiteiros reduzem o risco de malária

- **Amostra:** 1.752 domicílios (dados observacionais)

- **Contexto:** Estudo não-experimental - uso de mosquiteiros é por decisão própria das famílias

- **Variáveis disponíveis:** Fatores ambientais, de saúde e características domiciliares



-------------------------------------------------------------------

##  {#dados2 data-menu-title="Dados"}

[Nosso dataset]{.slide-title}

<hr>

`id`: Um identificador único para cada participante

`net e net_num`: Uma variável binária que indica se o participante usou mosquiteiro (1) ou não usou (0)

`malaria_risk`: Escala de risco de malária que varia de 0 a 100

`income`: Renda semanal, medida em dólares

`health`: Uma pontuação de saúde que varia de 0 a 100

`household`: Número de pessoas que moram na residência

`eligible`: Uma variável binária que indica se a residência é elegível para o programa de mosquiteiros gratuitos

`temperature`: A temperatura média durante a noite, em graus Celsius

`resistance`: Resistência a inseticidas dos mosquitos locais. Uma escala de 0 a 100, onde valores mais altos indicam maior resistência.

:::{.notes}

Because we’re using simulated data, we’ll have direct access to an outcome variable that measures the likelihood of contracting malaria, something we wouldn’t likely have in real life. We’ll stick with this measure because it allows us to more closely inspect the actual effect size, whereas, in practice, we would need to approximate the effect size through another proxy such as regular malaria testing among the population. 

:::

-------------------------------------------------------------------

##  {#dados data-menu-title="Dados"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

<hr>

```{r ex1, echo=TRUE, include=TRUE, warning=FALSE}
# Distribuição do risco de malária por uso de mosquiteiro
net_data |>
  ggplot(aes(malaria_risk, fill = net)) +
  geom_density(color = NA, alpha = .8)

```

-------------------------------------------------------------------

##  {#dados data-menu-title="Dados"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

<hr>

```{r ex2, echo=TRUE, include=TRUE, warning=FALSE}
# Diferença média simples
net_data |>
  group_by(net) |> 
  summarize(malaria_risk = mean(malaria_risk))

```

:::{.notes}
Diferença média ingênua: quem usa mosquiteiro tem risco 16.4 pontos menor. Pode ter viés por confundimento.
:::

-------------------------------------------------------------------

##  {#dados data-menu-title="Dados"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[O Grafo]{.custom-subtitle2}

<hr>

```{r ex3, echo=TRUE, include=TRUE, warning=FALSE}
malaria_dag <- dagify(
  malaria_risk ~ net + income + health + temperature + resistance,
  net ~ income + health + temperature + eligible + household,
  eligible ~ income + household,
  health ~ income,
  exposure = "net",
  outcome = "malaria_risk",
  labels = c(
    malaria_risk = "Malaria Risk",
    net = "Net Use",
    income = "Income",
    health = "Health",
    temperature = "Temperature",
    resistance = "Resistance",
    eligible = "Eligible",
    household = "Household Size"
  )
)

```

-------------------------------------------------------------------

##  {#grafo_malaria data-menu-title="Grafo do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[O Grafo]{.custom-subtitle2}

<hr>

```{r ex4, echo=TRUE, include=TRUE, warning=FALSE}
ggdag(malaria_dag, text = FALSE, use_labels = "label") +
  theme_dag()
```

:::{.notes}

1. Determinantes do Risco de Malária (malaria_risk):
- Uso de mosquiteiro (net) → Reduz risco de malária
- Renda (income) → Afeta risco (pessoas mais ricas podem ter melhor acesso a cuidados)
- Saúde (health) → Pessoas mais saudáveis têm menor risco
- Temperatura (temperature) → Temperaturas mais altas podem aumentar transmissão
- Resistência (resistance) → Resistência a inseticidas pode aumentar risco

2. Determinantes do Uso de Mosquiteiro (net):
- Renda (income) → Pessoas mais ricas podem comprar mosquiteiros
- Saúde (health) → Pessoas que se importam mais com saúde podem usar mais
- Temperatura (temperature) → Temperaturas mais altas podem aumentar uso
- Elegibilidade (eligible) → Programa gratuito aumenta uso
- Tamanho da família (household) → Famílias maiores podem ter diferentes padrões de uso

3. Determinantes da Elegibilidade (eligible):
- Renda (income) → Programas focam em pessoas de baixa renda
- Tamanho da família (household) → Famílias maiores podem ter prioridade

4. Determinante da Saúde (health):
- Renda (income) → Pessoas mais ricas têm melhor saúde
- Suposições de NÃO-Causalidade (ausência de setas)
- Relações que NÃO existem no modelo:
- Mosquiteiro → Renda (uso não afeta renda diretamente)
- Risco de malária → Saúde (não há feedback loop)
- Temperatura → Renda (temperatura não afeta renda diretamente)
- Resistência → Uso de mosquiteiro (resistência não afeta decisão de uso)
- Tamanho da família → Risco de malária (efeito apenas via uso de mosquiteiro)
:::

-------------------------------------------------------------------

##  {#modelo_ingenuo_malaria data-menu-title="Avaliação do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Modelo Ingênuo]{.custom-subtitle2}

<hr>

```{r model naive, echo=TRUE, include=TRUE, warning=FALSE}
modelo_naive <- lm(malaria_risk ~ net, data = net_data)
tidy(modelo_naive)
```

-------------------------------------------------------------------

##  {#avaliacao_grafo_malaria data-menu-title="Avaliação do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[O Grafo: Avaliação]{.custom-subtitle2}

<hr>

```{r ex5, echo=TRUE, include=TRUE, warning=FALSE}
# Todos os conjuntos possíveis
adjustment_sets <- dagitty::adjustmentSets(
  malaria_dag,
  type = "minimal",
  effect = "total"
)
print(adjustment_sets)
```

:::{.notes}
Conjunto mínimo de ajuste: {health, income, temperature}. Suficiente para bloquear todos os caminhos de confundimento.

10 caminhos totais: 1 causal direto + 9 de confundimento. 2 já fechados naturalmente (colidores).
:::
:::

-------------------------------------------------------------------

##  {#avaliacao_grafo_malaria2 data-menu-title="Avaliação do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[O Grafo: Avaliação]{.custom-subtitle2}

<hr>

```{r ex6, echo=TRUE, include=TRUE, warning=FALSE}
# Testar d-separação
dsep_test <- dagitty::dseparated(
  malaria_dag,
  "net", 
  "malaria_risk",
  c("income", "health", "temperature")
)

print(paste("D-separated:", dsep_test))
```

-------------------------------------------------------------------

##  {#avaliacao_grafo_malaria3 data-menu-title="Avaliação do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[O Grafo: Avaliação]{.custom-subtitle2}

<hr>

```{r ex7, echo=TRUE, include=TRUE, warning=FALSE}
paths <- dagitty::paths(
  malaria_dag,
  from = "net",
  to = "malaria_risk"
)

print(paths)
```

--------------------------------------------------------------------------

## {#avaliacao_grafo_malaria4 data-menu-title="Avaliação do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[O Grafo após ajuste]{.custom-subtitle2}

<hr>

```{r ex8, echo=TRUE, include=TRUE, warning=FALSE}

# ANTES do ajuste
antes <- ggdag_paths(malaria_dag,
                    from = "net", 
                    to = "malaria_risk",
                    shadow = TRUE,
                    text = FALSE) +
  theme_dag() +
  labs(title = "ANTES: Todos os caminhos abertos")

# DEPOIS do ajuste  
depois <- ggdag_paths(malaria_dag,
                     from = "net", 
                     to = "malaria_risk",
                     shadow = TRUE,
                     text = FALSE,
                     adjust_for = c("health", "income", "temperature")) +
  theme_dag() +
  labs(title = "DEPOIS: Apenas caminho causal aberto")
```

----------------------------------------------------------------------------

## {#avaliacao_grafo_malaria5 data-menu-title="Avaliação do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Caminhos abertos antes do ajuste]{.custom-subtitle2}

<hr>

```{r ex9, echo=TRUE, include=TRUE, warning=FALSE}
antes
```

----------------------------------------------------------------------------

## {#avaliacao_grafo_malaria6 data-menu-title="Avaliação do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Caminhos abertos depois do ajuste]{.custom-subtitle2}

<hr>

```{r ex10, echo=TRUE, include=TRUE, warning=FALSE}
depois
```


----------------------------------------------------------------------------

## {#avaliacao_grafo_malaria7 data-menu-title="Avaliação do Exemplo de Malaria"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Propensity Score]{.custom-subtitle2}

<hr>

```{r ex11, echo=TRUE, include=TRUE, warning=FALSE}
propensity_model <- glm(
  net ~ income + health + temperature,
  data = net_data,
  family = binomial()
)
```

----------------------------------------------------------------------------

## {#propensity_score data-menu-title="Propensity Score"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Propensity Score]{.custom-subtitle2}
<hr>

```{r ex12, echo=TRUE, include=TRUE, warning=FALSE}

# Cálculo dos pesos IPW (ATE)
net_data_wts <- propensity_model |>
  augment(data = net_data, type.predict = "response") |>
  mutate(wts = wt_ate(.fitted, net))

```

:::{.notes}
Modelo de propensity score: prediz probabilidade de usar mosquiteiro baseado nos confundidores. Pesos IPW criam pseudo-população balanceada.
:::

----------------------------------------------------------------------------

## {#diagnostico_balanceamento data-menu-title="Diagnóstico do Balanceamento"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Balanceamento do Propensity Score]{.custom-subtitle2}

<hr>

```{r ex13, echo=TRUE, include=TRUE, warning=FALSE}

# Balanceamento do propensity score
ggplot(net_data_wts, aes(.fitted)) +
  geom_mirror_histogram(aes(fill = net), bins = 50) +
  scale_y_continuous(labels = abs)

```

----------------------------------------------------------------------------

## {#balanceamento_ponderado data-menu-title="Balanceamento Ponderado"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Balanceamento Após Ponderação]{.custom-subtitle2}

<hr>

```{r ex14, echo=TRUE, include=TRUE, warning=FALSE}

# Balanceamento ponderado
ggplot(net_data_wts, aes(.fitted)) +
  geom_mirror_histogram(aes(group = net), bins = 50) +
  geom_mirror_histogram(
    aes(fill = net, weight = wts),
    bins = 50, alpha = .5
  ) +
  scale_y_continuous(labels = abs)

```

:::{.notes}
Após ponderação IPW: distribuições ficam muito similares entre grupos, indicando bom balanceamento.
:::

----------------------------------------------------------------------------

## {#smd_plot data-menu-title="Diferenças Padronizadas"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Love Plot - Diferenças Padronizadas]{.custom-subtitle2}

<hr>

```{r ex15, echo=TRUE, include=TRUE, warning=FALSE}

# Diferenças padronizadas de médias (SMD)
plot_df <- tidy_smd(
  net_data_wts,
  c(income, health, temperature),
  .group = net,
  .wts = wts
)

ggplot(plot_df, aes(x = abs(smd), y = variable, group = method, color = method)) +
  geom_love()
```

:::{.notes}
Love plot: SMD < 0.1 após ponderação indica bom balanceamento. IPW reduziu diferenças entre grupos.
:::

----------------------------------------------------------------------------

## {#distribuicao_pesos data-menu-title="Distribuição dos Pesos"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Distribuição dos Pesos IPW]{.custom-subtitle2}

<hr>

```{r ex16, echo=TRUE, include=TRUE, warning=FALSE}
# Distribuição dos pesos
net_data_wts |>
  ggplot(aes(wts)) +
  geom_density(fill = "#CC79A7", color = NA, alpha = 0.8)
```

:::{.notes}
Distribuição dos pesos: sem valores extremos que possam destabilizar as estimativas.
:::

----------------------------------------------------------------------------

## {#modelo_ipw data-menu-title="Modelo IPW"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Estimativa IPW do Efeito Causal]{.custom-subtitle2}

<hr>

```{r ex17, echo=TRUE, include=TRUE, warning=FALSE}
# Modelo ponderado
modelo_ipw <- lm(malaria_risk ~ net, data = net_data_wts, weights = wts)
tidy(modelo_ipw, conf.int = TRUE)
```

:::{.notes}
Efeito causal ajustado: -12.5 pontos de risco. Redução de 29% comparado ao modelo ingênuo (-16.4).
:::

----------------------------------------------------------------------------

## {#bootstrap_funcao data-menu-title="Bootstrap IPW"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Função Bootstrap para Intervalo de Confiança]{.custom-subtitle2}

<hr>

```{r ex18, echo=TRUE, include=TRUE, warning=FALSE}
# Função para bootstrap
fit_ipw <- function(.split, ...) {
  .df <- as.data.frame(.split)
  
  # Re-estimar tudo no bootstrap
  propensity_model <- glm(
    net ~ income + health + temperature,
    data = .df,
    family = binomial()
  )
  
  .df <- propensity_model |>
    augment(type.predict = "response", data = .df) |>
    mutate(wts = wt_ate(.fitted, net))
  
  lm(malaria_risk ~ net, data = .df, weights = wts) |>
    tidy()
}
```

:::{.notes}
Bootstrap corretamente re-estima propensity scores em cada amostra, incorporando incerteza da estimação dos pesos.
:::

----------------------------------------------------------------------------

## {#aplicar_bootstrap data-menu-title="Aplicar Bootstrap"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Aplicando Bootstrap]{.custom-subtitle2}

<hr>

```{r ex19, echo=TRUE, include=TRUE, warning=FALSE}
# Aplicar bootstrap
bootstrapped_net_data <- bootstraps(net_data, times = 1000, apparent = TRUE)

ipw_results <- bootstrapped_net_data |>
  mutate(boot_fits = map(splits, fit_ipw))

# Intervalos de confiança bootstrap
boot_estimate <- ipw_results |>
  int_t(boot_fits) |>
  filter(term == "netTRUE")

print(boot_estimate)
```

:::{.notes}
1000 amostras bootstrap criam distribuição empírica do efeito causal, incorporando toda a incerteza.

IC bootstrap corrigido: [-13.4, -11.7]. Mais conservador que IC ingênuo devido à incerteza dos pesos.
:::


----------------------------------------------------------------------------

## {#conclusao_exemplo data-menu-title="Conclusão do Exemplo"}

[Rede de mosquitos e Risco de Malária]{.slide-title}

[Conclusão]{.custom-subtitle2}

<hr>

- Conclusão: Uso de mosquiteiros reduz significativamente o risco de malária

- ATE estimado e Intervalo de confiança: -12,5[-13.4 , -11.7 ] com 95% de confiança

- Viés de confundimento: Modelo ingênuo superestimou o efeito em ~30%


----------------------------------------------------------------------------

